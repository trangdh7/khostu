@{
    ViewData["Title"] = "X√°c nh·∫≠n nh·∫≠n h√†ng";
    Layout = "~/Areas/TruongBPKythuat/Views/Layout/Layout.cshtml";
}
@model Webkho_20241021.Areas.TruongBPKythuat.Data.Phieuxuatkhoviewmodel

<div class="container">
    <div class="header">
        <h2>‚úÖ X√°c nh·∫≠n nh·∫≠n h√†ng</h2>
        <p>Danh s√°ch phi·∫øu xu·∫•t kho ƒëang ch·ªù b·∫°n x√°c nh·∫≠n nh·∫≠n h√†ng.</p>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 12px 16px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
            ‚úÖ @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 12px 16px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            ‚ö†Ô∏è @TempData["ErrorMessage"]
        </div>
    }

    @if (Model.Phieuxuatkho.Any())
    {
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ xu·∫•t kho</th>
                        <th>M√£ y√™u c·∫ßu</th>
                        <th>M√£ d·ª± √°n</th>
                        <th>Ng√†y xu·∫•t kho</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ghi ch√∫</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int stt = 1;
                    }
                    @foreach (var item in Model.Phieuxuatkho)
                    {
                        <tr>
                            <td>@stt</td>
                            <td>
                                <a href="javascript:void(0);" 
                                   onclick="showVTxuatkho('@item.MaXuatkho')" 
                                   style="color: #1976d2; text-decoration: none;">
                                   @item.MaXuatkho
                                </a>
                            </td>
                            <td>@item.MaYeucau</td>
                            <td>@item.MaDuan</td>
                            <td>@item.NgayXuatkho?.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                @{
                                    string color = item.TrangThai switch
                                    {
                                        "ƒê√£ ho√†n th√†nh" => "#4caf50",
                                        "ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng" => "#4caf50",
                                        "Ch·ªù x√°c nh·∫≠n" => "#ffc107",
                                        "Ch·ªù ng∆∞·ªùi y√™u c·∫ßu x√°c nh·∫≠n" => "#ff9800",
                                        "ƒêang chu·∫©n b·ªã h√†ng" => "#2196f3",
                                        _ => "#9e9e9e"
                                    };
                                }
                                <span class="status-badge" style="background-color:@color; color:white; padding:3px 8px; border-radius:4px;">
                                    @item.TrangThai
                                </span>
                            </td>
                            <td>@item.GhiChu</td>
                            <td>
                                @if (item.TrangThai == "Ch·ªù ng∆∞·ªùi y√™u c·∫ßu x√°c nh·∫≠n")
                                {
                                    <form asp-action="XacnhanNhanHang" method="post" style="display:inline-block;">
                                        <input type="hidden" name="MaXuatkho" value="@item.MaXuatkho" />
                                        <button type="submit" class="btn-confirm" style="background-color:#4caf50; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:13px;">
                                            ‚úÖ X√°c nh·∫≠n nh·∫≠n h√†ng
                                        </button>
                                    </form>
                                }
                                else if (item.TrangThai == "ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng" || item.TrangThai == "ƒê√£ ho√†n th√†nh")
                                {
                                    <span style="color:#4caf50; font-size:12px; font-weight:500;">‚úÖ ƒê√£ x√°c nh·∫≠n</span>
                                }
                                else
                                {
                                    <span style="color:#9e9e9e; font-size:12px;">-</span>
                                }
                            </td>
                        </tr>
                        stt++;
                    }
                </tbody>
            </table>
        </div>

        <!-- Chi ti·∫øt v·∫≠t t∆∞ -->
        <div class="material-details" style="margin-top: 30px;">
            <h3>üìã Chi ti·∫øt v·∫≠t t∆∞</h3>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n v·∫≠t t∆∞</th>
                            <th>M√£ v·∫≠t t∆∞</th>
                            <th>M√£ kho</th>
                            <th>H√£ng SX</th>
                            <th>Nh√† cung c·∫•p</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>ƒê∆°n v·ªã</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="materialDetails">
                        <tr>
                            <td colspan="9" style="text-align:center; color:#777;">
                                Ch·ªçn m·ªôt phi·∫øu xu·∫•t kho ƒë·ªÉ xem chi ti·∫øt v·∫≠t t∆∞.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="no-data" style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:48px; margin-bottom:20px;">üì≠</div>
            <h3>Kh√¥ng c√≥ d·ªØ li·ªáu phi·∫øu xu·∫•t kho</h3>
        </div>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function showVTxuatkho(MaXuatkho) {
            // ƒê·ªìng b·ªô tr·∫°ng th√°i v·∫≠t t∆∞ tr∆∞·ªõc khi hi·ªÉn th·ªã
            $.ajax({
                url: '@Url.Action("DongsBoTrangThaiVatTu", "Yeucau", new { area = "TruongBPKythuat" })',
                method: 'POST',
                data: { MaXuatkho: MaXuatkho },
                success: function (syncResult) {
                    // Sau khi ƒë·ªìng b·ªô, l·∫•y d·ªØ li·ªáu v·∫≠t t∆∞
                    $.ajax({
                        url: '@Url.Action("GetVTPhieuxuatkho", "Yeucau", new { area = "TruongBPKythuat" })',
                        method: 'GET',
                        data: { MaXuatkho: MaXuatkho },
                        success: function (data) {
                            $('#materialDetails').empty();
                            if (data && data.length > 0) {
                                let STT = 1;
                                data.forEach(item => {
                                    // X√°c ƒë·ªãnh m√†u s·∫Øc theo tr·∫°ng th√°i
                                    let bgColor = '#4caf50'; // M·∫∑c ƒë·ªãnh xanh l√°
                                    if (item.trangThai === 'ƒêang chu·∫©n b·ªã h√†ng') {
                                        bgColor = '#2196f3'; // Xanh d∆∞∆°ng
                                    } else if (item.trangThai === 'ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng') {
                                        bgColor = '#4caf50'; // Xanh l√°
                                    } else if (item.trangThai === 'ƒê√£ xu·∫•t kho') {
                                        bgColor = '#4caf50'; // Xanh l√°
                                    }

                                    $('#materialDetails').append(`
                                        <tr>
                                            <td>${STT++}</td>
                                            <td>${item.tenSanpham || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                                            <td>${item.maSanpham || '-'}</td>
                                            <td>${item.makho || '-'}</td>
                                            <td>${item.hangSX || '-'}</td>
                                            <td>${item.nhaCC || '-'}</td>
                                            <td>${item.sl || 0}</td>
                                            <td>${item.donVi || '-'}</td>
                                            <td>
                                                <span style="background-color:${bgColor}; color:white; padding:2px 6px; border-radius:3px; font-size:11px;">
                                                    ${item.trangThai || '-'}
                                                </span>
                                            </td>
                                        </tr>
                                    `);
                                });
                            } else {
                                $('#materialDetails').append(
                                    `<tr><td colspan="9" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu v·∫≠t t∆∞.</td></tr>`
                                );
                            }
                        },
                        error: function (xhr, status, error) {
                            alert("L·ªói khi t·∫£i d·ªØ li·ªáu v·∫≠t t∆∞: " + error);
                        }
                    });
                },
                error: function () {
                    // N·∫øu ƒë·ªìng b·ªô th·∫•t b·∫°i, v·∫´n ti·∫øp t·ª•c hi·ªÉn th·ªã d·ªØ li·ªáu
                    $.ajax({
                        url: '@Url.Action("GetVTPhieuxuatkho", "Yeucau", new { area = "TruongBPKythuat" })',
                        method: 'GET',
                        data: { MaXuatkho: MaXuatkho },
                        success: function (data) {
                            $('#materialDetails').empty();
                            if (data && data.length > 0) {
                                let STT = 1;
                                data.forEach(item => {
                                    let bgColor = '#4caf50';
                                    if (item.trangThai === 'ƒêang chu·∫©n b·ªã h√†ng') {
                                        bgColor = '#2196f3';
                                    }

                                    $('#materialDetails').append(`
                                        <tr>
                                            <td>${STT++}</td>
                                            <td>${item.tenSanpham || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                                            <td>${item.maSanpham || '-'}</td>
                                            <td>${item.makho || '-'}</td>
                                            <td>${item.hangSX || '-'}</td>
                                            <td>${item.nhaCC || '-'}</td>
                                            <td>${item.sl || 0}</td>
                                            <td>${item.donVi || '-'}</td>
                                            <td>
                                                <span style="background-color:${bgColor}; color:white; padding:2px 6px; border-radius:3px; font-size:11px;">
                                                    ${item.trangThai || '-'}
                                                </span>
                                            </td>
                                        </tr>
                                    `);
                                });
                            } else {
                                $('#materialDetails').append(
                                    `<tr><td colspan="9" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu v·∫≠t t∆∞.</td></tr>`
                                );
                            }
                        },
                        error: function (xhr, status, error) {
                            alert("L·ªói khi t·∫£i d·ªØ li·ªáu v·∫≠t t∆∞: " + error);
                        }
                    });
                }
            });
        }

        $(document).ready(function () {
            const firstRow = $('.table tbody tr').first();
            if (firstRow.length > 0) {
                const MaXuatkho = firstRow.find('td').eq(1).text().trim();
                showVTxuatkho(MaXuatkho);
            }
        });
    </script>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header h2 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .table-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background-color: #f5f5f5;
            color: #333;
            font-weight: 600;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-confirm:hover {
            background-color: #45a049 !important;
            opacity: 0.9;
        }

        .btn-confirm:active {
            transform: scale(0.98);
        }
    </style>
    <script>
        // Auto-hide alerts after 5 seconds
        $(document).ready(function() {
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>
}
